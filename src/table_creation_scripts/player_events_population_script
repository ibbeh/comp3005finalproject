import json
import os
import psycopg2
from psycopg2.extras import execute_values

def connect_db(host, dbname, user, password):
    conn = psycopg2.connect(host=host, dbname=dbname, user=user, password=password)
    return conn

def insert_data(conn, table, data):
    if data:
        columns = ', '.join(data[0].keys())
        values = [[value for value in entry.values()] for entry in data]
        placeholders = ', '.join(['%s'] * len(data[0]))
        insert_query = f"INSERT INTO {table} ({columns}) VALUES %s ON CONFLICT (player_id) DO NOTHING"
        cursor = conn.cursor()
        execute_values(cursor, insert_query, values)
        conn.commit()
        cursor.close()

def parse_json(json_file_path):
    with open(json_file_path, 'r') as file:
        data = json.load(file)
    return data

def process_players(json_data):
    players = []
    for team in json_data:
        team_id = team['team_id']
        for player in team['lineup']:
            player_data = {
                'player_id': player['player_id'],
                'player_name': player['player_name'],
                'player_nickname': player.get('player_nickname'),
                'jersey_number': player['jersey_number'],
                'country_id': player['country']['id'],
                'team_id': team_id,
                'position_id': player['positions'][0]['position_id'] if player['positions'] else None
                # Assume each player has at least one position logged, adjust if necessary
            }
            players.append(player_data)
    return players

def main():
    # Database credentials
    host = 'localhost'
    dbname = 'FUTDB'
    user = 'postgres'
    password = 'pass'

    # Connect to the database
    conn = connect_db(host, dbname, user, password)

    # Directory path containing JSON files
    directory_path = 'path_to_your_directory'

    # Loop through each file in the directory
    for filename in os.listdir(directory_path):
        if filename.endswith('.json') and filename.isdigit():
            json_file_path = os.path.join(directory_path, filename)
            
            # Parse JSON file
            json_data = parse_json(json_file_path)
            
            # Process and insert player data
            players = process_players(json_data)
            insert_data(conn, 'Players', players)

    # Close the database connection
    conn.close()

if __name__ == '__main__':
    main()
